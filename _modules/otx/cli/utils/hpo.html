<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>otx.cli.utils.hpo &mdash; OpenVINO Training Extensions  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> OpenVINO Training Extensions
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">OpenVINO Training Extensions</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
          <li><a href="../../../otx.html">otx</a> &raquo;</li>
      <li>otx.cli.utils.hpo</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for otx.cli.utils.hpo</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Utils for HPO with hpopt.&quot;&quot;&quot;</span>

<span class="c1"># Copyright (C) 2021-2022 Intel Corporation</span>
<span class="c1"># SPDX-License-Identifier: Apache-2.0</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">builtins</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>  <span class="c1"># nosec</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span>  <span class="c1"># nosec</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># pylint: disable=too-many-locals, too-many-instance-attributes, too-many-branches, too-many-statements</span>
<span class="c1"># disbled some pylint refactor related categories</span>
<span class="c1"># TODO: refactor code to resolve these things</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">isclass</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">ceil</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span> <span class="k">as</span> <span class="n">osp</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">from</span> <span class="nn">otx.api.configuration.configurable_parameters</span> <span class="kn">import</span> <span class="n">ConfigurableParameters</span>
<span class="kn">from</span> <span class="nn">otx.api.configuration.helper</span> <span class="kn">import</span> <span class="n">create</span>
<span class="kn">from</span> <span class="nn">otx.api.entities.datasets</span> <span class="kn">import</span> <span class="n">DatasetEntity</span>
<span class="kn">from</span> <span class="nn">otx.api.entities.model</span> <span class="kn">import</span> <span class="n">ModelEntity</span>
<span class="kn">from</span> <span class="nn">otx.api.entities.model_template</span> <span class="kn">import</span> <span class="n">TaskType</span>
<span class="kn">from</span> <span class="nn">otx.api.entities.subset</span> <span class="kn">import</span> <span class="n">Subset</span>
<span class="kn">from</span> <span class="nn">otx.api.entities.task_environment</span> <span class="kn">import</span> <span class="n">TaskEnvironment</span><span class="p">,</span> <span class="n">TypeVariable</span>
<span class="kn">from</span> <span class="nn">otx.api.entities.train_parameters</span> <span class="kn">import</span> <span class="n">TrainParameters</span><span class="p">,</span> <span class="n">UpdateProgressCallback</span>
<span class="kn">from</span> <span class="nn">otx.cli.datasets</span> <span class="kn">import</span> <span class="n">get_dataset_class</span>
<span class="kn">from</span> <span class="nn">otx.cli.utils.importing</span> <span class="kn">import</span> <span class="n">get_impl_class</span>
<span class="kn">from</span> <span class="nn">otx.cli.utils.io</span> <span class="kn">import</span> <span class="n">generate_label_schema</span><span class="p">,</span> <span class="n">read_model</span><span class="p">,</span> <span class="n">save_model_data</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">hpopt</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;cannot import hpopt module&quot;</span><span class="p">)</span>
<div class="viewcode-block" id="hpopt"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.hpopt">[docs]</a>    <span class="n">hpopt</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="check_hpopt_available"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.check_hpopt_available">[docs]</a><span class="k">def</span> <span class="nf">check_hpopt_available</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check whether hpopt is avaiable.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">hpopt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="_check_hpo_enabled_task"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo._check_hpo_enabled_task">[docs]</a><span class="k">def</span> <span class="nf">_check_hpo_enabled_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">:</span> <span class="n">TaskType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether HPO available task.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">task_type</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">CLASSIFICATION</span><span class="p">,</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">DETECTION</span><span class="p">,</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">SEGMENTATION</span><span class="p">,</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">INSTANCE_SEGMENTATION</span><span class="p">,</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">ROTATED_DETECTION</span><span class="p">,</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">ANOMALY_CLASSIFICATION</span><span class="p">,</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">ANOMALY_DETECTION</span><span class="p">,</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">ANOMALY_SEGMENTATION</span><span class="p">,</span>
    <span class="p">]</span></div>


<div class="viewcode-block" id="_is_mpa_framework_task"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo._is_mpa_framework_task">[docs]</a><span class="k">def</span> <span class="nf">_is_mpa_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">:</span> <span class="n">TaskType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether mpa framework task.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_is_cls_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_is_det_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_is_seg_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">)</span></div>


<div class="viewcode-block" id="_is_cls_framework_task"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo._is_cls_framework_task">[docs]</a><span class="k">def</span> <span class="nf">_is_cls_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">:</span> <span class="n">TaskType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether classification framework task.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">task_type</span> <span class="o">==</span> <span class="n">TaskType</span><span class="o">.</span><span class="n">CLASSIFICATION</span></div>


<div class="viewcode-block" id="_is_det_framework_task"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo._is_det_framework_task">[docs]</a><span class="k">def</span> <span class="nf">_is_det_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">:</span> <span class="n">TaskType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether detection framework task.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">task_type</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">DETECTION</span><span class="p">,</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">INSTANCE_SEGMENTATION</span><span class="p">,</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">ROTATED_DETECTION</span><span class="p">,</span>
    <span class="p">]</span></div>


<div class="viewcode-block" id="_is_seg_framework_task"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo._is_seg_framework_task">[docs]</a><span class="k">def</span> <span class="nf">_is_seg_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">:</span> <span class="n">TaskType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether segmentation framework task.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">task_type</span> <span class="o">==</span> <span class="n">TaskType</span><span class="o">.</span><span class="n">SEGMENTATION</span></div>


<div class="viewcode-block" id="_is_anomaly_framework_task"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo._is_anomaly_framework_task">[docs]</a><span class="k">def</span> <span class="nf">_is_anomaly_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">:</span> <span class="n">TaskType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check whether anomaly framework task.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">task_type</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">ANOMALY_CLASSIFICATION</span><span class="p">,</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">ANOMALY_DETECTION</span><span class="p">,</span>
        <span class="n">TaskType</span><span class="o">.</span><span class="n">ANOMALY_SEGMENTATION</span><span class="p">,</span>
    <span class="p">]</span></div>


<div class="viewcode-block" id="run_hpo"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.run_hpo">[docs]</a><span class="k">def</span> <span class="nf">run_hpo</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Namespace</span><span class="p">,</span> <span class="n">environment</span><span class="p">:</span> <span class="n">TaskEnvironment</span><span class="p">,</span> <span class="n">dataset</span><span class="p">:</span> <span class="n">DatasetEntity</span><span class="p">,</span> <span class="n">task_type</span><span class="p">:</span> <span class="n">TaskType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the environment with better hyper-parameters found by HPO.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_hpopt_available</span><span class="p">():</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_hpo_enabled_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Currently supported task types are classification, detection, segmentation and anomaly&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_type</span><span class="si">}</span><span class="s2"> is not supported yet.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">dataset_paths</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;train_ann_file&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">train_ann_files</span><span class="p">,</span>
        <span class="s2">&quot;train_data_root&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">train_data_roots</span><span class="p">,</span>
        <span class="s2">&quot;val_ann_file&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">val_ann_files</span><span class="p">,</span>
        <span class="s2">&quot;val_data_root&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">val_data_roots</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">hpo_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">save_model_to</span><span class="p">),</span> <span class="s2">&quot;hpo&quot;</span><span class="p">))</span>
    <span class="n">hpo</span> <span class="o">=</span> <span class="n">HpoManager</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">dataset_paths</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">hpo_time_ratio</span><span class="p">,</span> <span class="n">hpo_save_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span><span class="si">}</span><span class="s2"> [HPO] started hyper-parameter optimization&quot;</span><span class="p">)</span>
    <span class="n">hyper_parameters</span><span class="p">,</span> <span class="n">hpo_weight_path</span> <span class="o">=</span> <span class="n">hpo</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">())</span><span class="si">}</span><span class="s2"> [HPO] completed hyper-parameter optimization&quot;</span><span class="p">)</span>

    <span class="n">environment</span><span class="o">.</span><span class="n">set_hyper_parameters</span><span class="p">(</span><span class="n">hyper_parameters</span><span class="p">)</span>

    <span class="k">assert</span> <span class="p">(</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">entrypoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">environment</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">entrypoints</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="p">)</span>
    <span class="n">task_class</span> <span class="o">=</span> <span class="n">get_impl_class</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">entrypoints</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
    <span class="n">task_class</span> <span class="o">=</span> <span class="n">get_train_wrapper_task</span><span class="p">(</span><span class="n">task_class</span><span class="p">,</span> <span class="n">task_type</span><span class="p">)</span>

    <span class="n">task</span> <span class="o">=</span> <span class="n">task_class</span><span class="p">(</span><span class="n">task_environment</span><span class="o">=</span><span class="n">environment</span><span class="p">)</span>

    <span class="n">hpopt_cfg</span> <span class="o">=</span> <span class="n">_load_hpopt_config</span><span class="p">(</span>
        <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">model_template_path</span><span class="p">),</span>
            <span class="s2">&quot;hpo_config.yaml&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resume&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">task</span><span class="o">.</span><span class="n">set_resume_path_to_config</span><span class="p">(</span><span class="n">hpo_weight_path</span><span class="p">)</span>  <span class="c1"># prepare finetune stage to resume</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">load_weights</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">environment</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">configurable_parameters</span> <span class="o">=</span> <span class="n">hyper_parameters</span>

    <span class="k">return</span> <span class="n">task</span></div>


<div class="viewcode-block" id="get_cuda_device_list"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.get_cuda_device_list">[docs]</a><span class="k">def</span> <span class="nf">get_cuda_device_list</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Returns the list of avaiable cuda devices.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">hpo_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cuda_visible_devices</span> <span class="o">=</span> <span class="n">hpo_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cuda_visible_devices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()))</span>

        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cuda_visible_devices</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)]</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="run_hpo_trainer"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.run_hpo_trainer">[docs]</a><span class="k">def</span> <span class="nf">run_hpo_trainer</span><span class="p">(</span>
    <span class="n">hp_config</span><span class="p">,</span>
    <span class="n">hyper_parameters</span><span class="p">,</span>
    <span class="n">model_template</span><span class="p">,</span>
    <span class="n">dataset_paths</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">task_type</span><span class="p">:</span> <span class="n">TaskType</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run each training of each trial with given hyper parameters.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dataset_paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dataset is not defined.&quot;</span><span class="p">)</span>

    <span class="c1"># User argument Parameters are applied to HPO trial</span>
    <span class="n">default_hp</span> <span class="o">=</span> <span class="n">create</span><span class="p">(</span><span class="n">model_template</span><span class="o">.</span><span class="n">hyper_parameters</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">_set_dict_to_parameter_group</span><span class="p">(</span><span class="n">default_hp</span><span class="p">,</span> <span class="n">hyper_parameters</span><span class="p">)</span>
    <span class="n">hyper_parameters</span> <span class="o">=</span> <span class="n">default_hp</span>

    <span class="c1"># set epoch and warm-up stage depending on given epoch</span>
    <span class="k">if</span> <span class="n">_is_cls_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
        <span class="n">hyper_parameters</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">num_iters</span> <span class="o">=</span> <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;iterations&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">_is_det_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;bracket&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hp_config</span><span class="p">:</span>
            <span class="n">hyper_parameters</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">learning_rate_warmup_iters</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">hyper_parameters</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">learning_rate_warmup_iters</span>
                <span class="o">*</span> <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;iterations&quot;</span><span class="p">]</span>
                <span class="o">/</span> <span class="n">hyper_parameters</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">num_iters</span>
            <span class="p">)</span>
        <span class="n">hyper_parameters</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">num_iters</span> <span class="o">=</span> <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;iterations&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">_is_seg_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;bracket&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hp_config</span><span class="p">:</span>
            <span class="n">eph_comp</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">hyper_parameters</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">learning_rate_fixed_iters</span><span class="p">,</span>
                <span class="n">hyper_parameters</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">learning_rate_warmup_iters</span><span class="p">,</span>
                <span class="n">hyper_parameters</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">num_iters</span><span class="p">,</span>
            <span class="p">]</span>

            <span class="n">eph_comp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;iterations&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">eph_comp</span><span class="p">),</span> <span class="n">eph_comp</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eph_comp</span><span class="p">))),</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">k</span><span class="p">:</span> <span class="n">eph_comp</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">eph_comp</span><span class="p">[</span><span class="n">k</span><span class="p">]),</span>
                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)[:</span> <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;iterations&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">eph_comp</span><span class="p">))]:</span>
                <span class="n">eph_comp</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">hyper_parameters</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">learning_rate_fixed_iters</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">eph_comp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">hyper_parameters</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">learning_rate_warmup_iters</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">eph_comp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">hyper_parameters</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">num_iters</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">eph_comp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hyper_parameters</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">num_iters</span> <span class="o">=</span> <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;iterations&quot;</span><span class="p">]</span>

    <span class="c1"># current HPO requires batch_size information.</span>
    <span class="c1"># so if batch_size is not in the HPO&#39;s target hyper parameters,</span>
    <span class="c1"># need to set batch_size config from the instance of ConfigurableParameters</span>
    <span class="k">if</span> <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;batch_size_param_name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">attr</span> <span class="o">=</span> <span class="n">hyper_parameters</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;batch_size_param_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
            <span class="c1"># TODO explicitly check for typing</span>
            <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>  <span class="c1"># type: ignore[call-overload]</span>
        <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;batch_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span>

    <span class="c1"># set hyper-parameters and print them</span>
    <span class="n">HpoManager</span><span class="o">.</span><span class="n">set_hyperparameter</span><span class="p">(</span><span class="n">hyper_parameters</span><span class="p">,</span> <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;hyper parameter of current trial : </span><span class="si">{</span><span class="n">hp_config</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">dataset_class</span> <span class="o">=</span> <span class="n">get_dataset_class</span><span class="p">(</span><span class="n">task_type</span><span class="p">)</span>
    <span class="c1"># TODO remove None from dataset_paths</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset_class</span><span class="p">(</span>
        <span class="n">train_subset</span><span class="o">=</span><span class="p">{</span>  <span class="c1"># type: ignore</span>
            <span class="s2">&quot;ann_file&quot;</span><span class="p">:</span> <span class="n">dataset_paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;train_ann_file&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;data_root&quot;</span><span class="p">:</span> <span class="n">dataset_paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;train_data_root&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">val_subset</span><span class="o">=</span><span class="p">{</span>  <span class="c1"># type: ignore</span>
            <span class="s2">&quot;ann_file&quot;</span><span class="p">:</span> <span class="n">dataset_paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;val_ann_file&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s2">&quot;data_root&quot;</span><span class="p">:</span> <span class="n">dataset_paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;val_data_root&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="n">train_env</span> <span class="o">=</span> <span class="n">TaskEnvironment</span><span class="p">(</span>
        <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">hyper_parameters</span><span class="o">=</span><span class="n">hyper_parameters</span><span class="p">,</span>
        <span class="n">label_schema</span><span class="o">=</span><span class="n">generate_label_schema</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">task_type</span><span class="p">),</span>
        <span class="n">model_template</span><span class="o">=</span><span class="n">model_template</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># load fixed initial weight</span>
    <span class="n">save_initial_weight_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">initial_weight_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_get_hpo_dir</span><span class="p">(</span><span class="n">hp_config</span><span class="p">),</span> <span class="s2">&quot;weights.pth&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">initial_weight_path</span><span class="p">):</span>
        <span class="n">train_env</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">read_model</span><span class="p">(</span>
            <span class="n">train_env</span><span class="o">.</span><span class="n">get_model_configuration</span><span class="p">(),</span>
            <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;file_path&quot;</span><span class="p">]),</span> <span class="s2">&quot;weights.pth&quot;</span><span class="p">),</span>
            <span class="c1"># TODO replace None in read_model.</span>
            <span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">save_initial_weight_flag</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">train_env</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">hpo</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;hp_config&quot;</span><span class="p">:</span> <span class="n">hp_config</span><span class="p">,</span>
        <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="k">assert</span> <span class="n">train_env</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">entrypoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">train_env</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">entrypoints</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="n">task_class</span> <span class="o">=</span> <span class="n">get_impl_class</span><span class="p">(</span><span class="n">train_env</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">entrypoints</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
    <span class="n">hpo_impl_class</span> <span class="o">=</span> <span class="n">get_train_wrapper_task</span><span class="p">(</span><span class="n">task_class</span><span class="p">,</span> <span class="n">task_type</span><span class="p">)</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">hpo_impl_class</span><span class="p">(</span><span class="n">task_environment</span><span class="o">=</span><span class="n">train_env</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">prepare_hpo</span><span class="p">(</span><span class="n">hp_config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">save_initial_weight_flag</span><span class="p">:</span>
        <span class="n">task</span><span class="o">.</span><span class="n">prepare_saving_initial_weight</span><span class="p">(</span><span class="n">_get_hpo_dir</span><span class="p">(</span><span class="n">hp_config</span><span class="p">))</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">HpoDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">hp_config</span><span class="p">)</span>

    <span class="n">output_model</span> <span class="o">=</span> <span class="n">ModelEntity</span><span class="p">(</span>
        <span class="n">dataset</span><span class="p">,</span>
        <span class="n">train_env</span><span class="o">.</span><span class="n">get_model_configuration</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="c1"># make callback to report score to hpopt every epoch</span>
    <span class="n">train_param</span> <span class="o">=</span> <span class="n">TrainParameters</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">HpoCallback</span><span class="p">(</span><span class="n">hp_config</span><span class="p">,</span> <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">],</span> <span class="n">task</span><span class="p">))</span>

    <span class="n">task</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">output_model</span><span class="o">=</span><span class="n">output_model</span><span class="p">,</span> <span class="n">train_parameters</span><span class="o">=</span><span class="n">train_param</span><span class="p">)</span>

    <span class="n">hpopt</span><span class="o">.</span><span class="n">finalize_trial</span><span class="p">(</span><span class="n">hp_config</span><span class="p">)</span>

    <span class="c1"># align MPA checkpoint file to OTX weight file format</span>
    <span class="k">if</span> <span class="n">save_initial_weight_flag</span><span class="p">:</span>
        <span class="n">initial_weight</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">initial_weight_path</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="n">initial_weight</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_weight</span><span class="p">[</span><span class="s2">&quot;state_dict&quot;</span><span class="p">]</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">initial_weight</span><span class="p">,</span> <span class="n">initial_weight_path</span><span class="p">)</span>

    <span class="c1"># remove model weight except best model weight</span>
    <span class="n">best_model_weight</span> <span class="o">=</span> <span class="n">_get_best_model_weight_path</span><span class="p">(</span><span class="n">_get_hpo_dir</span><span class="p">(</span><span class="n">hp_config</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;trial_id&quot;</span><span class="p">]),</span> <span class="n">task_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">best_model_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">best_model_weight</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">best_model_weight</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">_get_hpo_trial_workdir</span><span class="p">(</span><span class="n">hp_config</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="n">full_name</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">full_name</span><span class="p">))</span> <span class="ow">and</span> <span class="n">full_name</span> <span class="o">!=</span> <span class="n">best_model_weight</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="exec_hpo_trainer"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.exec_hpo_trainer">[docs]</a><span class="k">def</span> <span class="nf">exec_hpo_trainer</span><span class="p">(</span><span class="n">arg_file_name</span><span class="p">,</span> <span class="n">alloc_gpus</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Execute new process to train model for ASHA&#39;s trial.&quot;&quot;&quot;</span>

    <span class="n">gpu_ids</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">alloc_gpus</span><span class="p">)</span>
    <span class="n">trainer_file_name</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">hpo_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">hpo_env</span><span class="p">[</span><span class="s2">&quot;CUDA_VISIBLE_DEVICES&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gpu_ids</span>
    <span class="n">hpo_env</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="si">}</span><span class="s2">/../../:&quot;</span> <span class="o">+</span> <span class="n">hpo_env</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;python3&quot;</span><span class="p">,</span> <span class="n">trainer_file_name</span><span class="p">,</span> <span class="n">arg_file_name</span><span class="p">],</span>
        <span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">env</span><span class="o">=</span><span class="n">hpo_env</span><span class="p">,</span>
        <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_train_wrapper_task"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.get_train_wrapper_task">[docs]</a><span class="k">def</span> <span class="nf">get_train_wrapper_task</span><span class="p">(</span><span class="n">impl_class</span><span class="p">,</span> <span class="n">task_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get task wrapper for the HPO with given task type.&quot;&quot;&quot;</span>

    <span class="c1"># pylint: disable=attribute-defined-outside-init</span>
    <span class="k">class</span> <span class="nc">HpoTrainTask</span><span class="p">(</span><span class="n">impl_class</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;wrapper class for the HPO.&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_environment</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">task_environment</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task_type</span> <span class="o">=</span> <span class="n">task_type</span>

        <span class="c1"># TODO: need to check things below whether works on MPA tasks</span>
        <span class="k">def</span> <span class="nf">set_resume_path_to_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resume_path</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Set path for the resume to the config of the each task framework.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">_is_cls_framework_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">resume_path</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">save_initial_metric</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">_is_det_framework_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">resume_from</span> <span class="o">=</span> <span class="n">resume_path</span>
            <span class="k">elif</span> <span class="n">_is_seg_framework_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_type</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="o">.</span><span class="n">resume_from</span> <span class="o">=</span> <span class="n">resume_path</span>

        <span class="k">def</span> <span class="nf">prepare_hpo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hp_config</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Update config of the each task framework for the HPO.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">_is_mpa_framework_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_type</span><span class="p">):</span>
                <span class="n">cfg</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">checkpoint_config</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">max_keep_ckpts</span><span class="o">=</span><span class="p">(</span><span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;iterations&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_override_configurations</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_output_path</span> <span class="o">=</span> <span class="n">_get_hpo_trial_workdir</span><span class="p">(</span><span class="n">hp_config</span><span class="p">)</span>  <span class="c1"># pylint: disable=attribute-defined-outside-init</span>

        <span class="k">def</span> <span class="nf">prepare_saving_initial_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Add a hook which saves initial model weight before training.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">_is_mpa_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
                <span class="n">cfg</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;custom_hooks&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;SaveInitialWeightHook&quot;</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">)]}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">update_override_configurations</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;If task is not classification, detection or segmentation,&quot;</span>
                    <span class="s2">&quot;initial weight should be saved before HPO.&quot;</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">HpoTrainTask</span></div>


<div class="viewcode-block" id="_convert_parameter_group_to_dict"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo._convert_parameter_group_to_dict">[docs]</a><span class="k">def</span> <span class="nf">_convert_parameter_group_to_dict</span><span class="p">(</span><span class="n">parameter_group</span><span class="p">:</span> <span class="n">TypeVariable</span><span class="p">):</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parameter_group</span><span class="p">,</span> <span class="s2">&quot;groups&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parameter_group</span><span class="p">,</span> <span class="s2">&quot;parameters&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">total_arr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[</span><span class="n">groups</span><span class="p">,</span> <span class="n">parameters</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">total_arr</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">total_arr</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parameter_group</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">total_arr</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">_convert_parameter_group_to_dict</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">parameter_group</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">isclass</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">Enum</span><span class="p">)):</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">return</span> <span class="n">ret</span></div>


<div class="viewcode-block" id="_set_dict_to_parameter_group"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo._set_dict_to_parameter_group">[docs]</a><span class="k">def</span> <span class="nf">_set_dict_to_parameter_group</span><span class="p">(</span><span class="n">origin_hp</span><span class="p">:</span> <span class="n">ConfigurableParameters</span><span class="p">,</span> <span class="n">hp_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set given hyper parameter to hyper parameter in environment aligning with &quot;ConfigurableParameters&quot;.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">hp_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">origin_hp</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_set_dict_to_parameter_group</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">origin_hp</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">val</span><span class="p">)</span></div>


<div class="viewcode-block" id="_load_hpopt_config"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo._load_hpopt_config">[docs]</a><span class="k">def</span> <span class="nf">_load_hpopt_config</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load HPOpt config file.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">hpopt_cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hpo_config.yaml file should be in directory where template.yaml is.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">err</span>

    <span class="k">return</span> <span class="n">hpopt_cfg</span></div>


<div class="viewcode-block" id="_get_best_model_weight_path"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo._get_best_model_weight_path">[docs]</a><span class="k">def</span> <span class="nf">_get_best_model_weight_path</span><span class="p">(</span><span class="n">hpo_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">trial_num</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task_type</span><span class="p">:</span> <span class="n">TaskType</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return best model weight from HPO trial directory.&quot;&quot;&quot;</span>
    <span class="n">best_weight_path</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">_is_mpa_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
        <span class="n">best_arr</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hpo_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">trial_num</span><span class="p">)))</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/best*.pth&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">best_name_file</span> <span class="ow">in</span> <span class="n">best_arr</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">osp</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">best_name_file</span><span class="p">):</span>
                <span class="n">best_weight_path</span> <span class="o">=</span> <span class="n">best_name_file</span>
                <span class="k">break</span>
    <span class="k">elif</span> <span class="n">_is_anomaly_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
        <span class="c1"># TODO need to implement later</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">best_weight_path</span></div>


<div class="viewcode-block" id="_get_hpo_dir"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo._get_hpo_dir">[docs]</a><span class="k">def</span> <span class="nf">_get_hpo_dir</span><span class="p">(</span><span class="n">hp_config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return HPO work directory path from hp_config.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;file_path&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="_get_hpo_trial_workdir"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo._get_hpo_trial_workdir">[docs]</a><span class="k">def</span> <span class="nf">_get_hpo_trial_workdir</span><span class="p">(</span><span class="n">hp_config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return HPO trial work directory path from hp_config.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_get_hpo_dir</span><span class="p">(</span><span class="n">hp_config</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;trial_id&quot;</span><span class="p">]))</span></div>


<div class="viewcode-block" id="HpoCallback"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoCallback">[docs]</a><span class="k">class</span> <span class="nc">HpoCallback</span><span class="p">(</span><span class="n">UpdateProgressCallback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Callback class to report score to hpopt.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hp_config</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">hpo_task</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hp_config</span> <span class="o">=</span> <span class="n">hp_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hpo_task</span> <span class="o">=</span> <span class="n">hpo_task</span>

<div class="viewcode-block" id="HpoCallback.__call__"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoCallback.__call__">[docs]</a>    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reports score to hpopt when called.</span>

<span class="sd">        Args:</span>
<span class="sd">            progress (float): (Unused) This is an artifact of using ProgressCallback for HPOCallback.</span>
<span class="sd">            score (Optional[float], optional): Score to report. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">current_iters</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">current_iters</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">score</span> <span class="o">-</span> <span class="n">current_iters</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">current_iters</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">score</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;score = </span><span class="si">{</span><span class="n">score</span><span class="si">}</span><span class="s2"> at iteration </span><span class="si">{</span><span class="n">current_iters</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># pylint: disable=unexpected-keyword-arg</span>
            <span class="k">if</span> <span class="n">hpopt</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hp_config</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span> <span class="n">current_iters</span><span class="o">=</span><span class="n">current_iters</span><span class="p">)</span> <span class="o">==</span> <span class="n">hpopt</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">STOP</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hpo_task</span><span class="o">.</span><span class="n">cancel_training</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="HpoManager"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoManager">[docs]</a><span class="k">class</span> <span class="nc">HpoManager</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Manage overall HPO process.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">dataset_paths</span><span class="p">,</span> <span class="n">expected_time_ratio</span><span class="p">,</span> <span class="n">hpo_save_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">environment</span> <span class="o">=</span> <span class="n">environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_paths</span> <span class="o">=</span> <span class="n">dataset_paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span> <span class="o">=</span> <span class="n">hpo_save_path</span>
        <span class="c1"># If hyper parameter candidates should be fixed,</span>
        <span class="c1"># they&#39;re excluded from hp search space.</span>
        <span class="c1"># But they are used in hpo and included to final hyper parameters as fixed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed_hp</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">task_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">task_type</span>
        <span class="k">if</span> <span class="n">environment</span><span class="o">.</span><span class="n">model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#  Fixed initial weight is saved during first trial,</span>
            <span class="c1">#  if task is the one ofcalssification, detection and segmentation.</span>
            <span class="k">if</span> <span class="n">_is_anomaly_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
                <span class="n">impl_class</span> <span class="o">=</span> <span class="n">get_impl_class</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">entrypoints</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">impl_class</span><span class="p">(</span><span class="n">task_environment</span><span class="o">=</span><span class="n">environment</span><span class="p">)</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">ModelEntity</span><span class="p">(</span>
                    <span class="n">dataset</span><span class="p">,</span>
                    <span class="n">environment</span><span class="o">.</span><span class="n">get_model_configuration</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="n">task</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="n">save_model_data</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">save_model_data</span><span class="p">(</span><span class="n">environment</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">)</span>

        <span class="n">hpopt_cfg</span> <span class="o">=</span> <span class="n">_load_hpopt_config</span><span class="p">(</span>
            <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">model_template_path</span><span class="p">),</span>
                <span class="s2">&quot;hpo_config.yaml&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">algo</span> <span class="o">=</span> <span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;search_algorithm&quot;</span><span class="p">,</span> <span class="s2">&quot;smbo&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metric&quot;</span><span class="p">,</span> <span class="s2">&quot;mAP&quot;</span><span class="p">)</span>

        <span class="n">num_available_gpus</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_gpus_per_trial</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">train_dataset_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="n">Subset</span><span class="o">.</span><span class="n">TRAINING</span><span class="p">))</span>
        <span class="n">val_dataset_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="n">Subset</span><span class="o">.</span><span class="n">VALIDATION</span><span class="p">))</span>

        <span class="c1"># make batch size range lower than train set size</span>
        <span class="n">env_hp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_hyper_parameters</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">_is_mpa_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
            <span class="n">batch_size_name</span> <span class="o">=</span> <span class="s2">&quot;learning_parameters.batch_size&quot;</span>
        <span class="k">elif</span> <span class="n">_is_anomaly_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
            <span class="n">batch_size_name</span> <span class="o">=</span> <span class="s2">&quot;learning_parameters.train_batch_size&quot;</span>
        <span class="k">if</span> <span class="n">batch_size_name</span> <span class="ow">in</span> <span class="n">hpopt_cfg</span><span class="p">[</span><span class="s2">&quot;hp_space&quot;</span><span class="p">]:</span>
            <span class="n">batch_range</span> <span class="o">=</span> <span class="n">hpopt_cfg</span><span class="p">[</span><span class="s2">&quot;hp_space&quot;</span><span class="p">][</span><span class="n">batch_size_name</span><span class="p">][</span><span class="s2">&quot;range&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">batch_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">train_dataset_size</span><span class="p">:</span>
                <span class="n">batch_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_dataset_size</span>

            <span class="c1"># If trainset size is lower than min batch size range,</span>
            <span class="c1"># fix batch size to trainset size</span>
            <span class="k">if</span> <span class="n">batch_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">batch_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Train set size is lower than batch size range. Batch size is fixed to train set size.&quot;</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">hpopt_cfg</span><span class="p">[</span><span class="s2">&quot;hp_space&quot;</span><span class="p">][</span><span class="n">batch_size_name</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fixed_hp</span><span class="p">[</span><span class="n">batch_size_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_dataset_size</span>

        <span class="c1"># prepare default hyper parameters</span>
        <span class="n">default_hyper_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hpopt_cfg</span><span class="p">[</span><span class="s2">&quot;hp_space&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">splited_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">env_hp</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">splited_key</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">default_hyper_parameters</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>

        <span class="n">hpopt_arguments</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">search_alg</span><span class="o">=</span><span class="s2">&quot;bayes_opt&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algo</span> <span class="o">==</span> <span class="s2">&quot;smbo&quot;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">algo</span><span class="p">,</span>
            <span class="n">search_space</span><span class="o">=</span><span class="n">HpoManager</span><span class="o">.</span><span class="n">generate_hpo_search_space</span><span class="p">(</span><span class="n">hpopt_cfg</span><span class="p">[</span><span class="s2">&quot;hp_space&quot;</span><span class="p">]),</span>
            <span class="n">early_stop</span><span class="o">=</span><span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;early_stop&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">resume</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">check_resumable</span><span class="p">(),</span>
            <span class="n">save_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span>
            <span class="n">max_iterations</span><span class="o">=</span><span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_iterations&quot;</span><span class="p">),</span>
            <span class="n">subset_ratio</span><span class="o">=</span><span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;subset_ratio&quot;</span><span class="p">),</span>
            <span class="n">num_full_iterations</span><span class="o">=</span><span class="n">HpoManager</span><span class="o">.</span><span class="n">get_num_full_iterations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="p">),</span>
            <span class="n">full_dataset_size</span><span class="o">=</span><span class="n">train_dataset_size</span><span class="p">,</span>
            <span class="n">expected_time_ratio</span><span class="o">=</span><span class="n">expected_time_ratio</span><span class="p">,</span>
            <span class="n">non_pure_train_ratio</span><span class="o">=</span><span class="n">val_dataset_size</span> <span class="o">/</span> <span class="p">(</span><span class="n">train_dataset_size</span> <span class="o">+</span> <span class="n">val_dataset_size</span><span class="p">),</span>
            <span class="n">batch_size_name</span><span class="o">=</span><span class="n">batch_size_name</span><span class="p">,</span>
            <span class="n">default_hyper_parameters</span><span class="o">=</span><span class="n">default_hyper_parameters</span><span class="p">,</span>
            <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algo</span> <span class="o">==</span> <span class="s2">&quot;smbo&quot;</span><span class="p">:</span>
            <span class="n">hpopt_arguments</span><span class="p">[</span><span class="s2">&quot;num_init_trials&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_init_trials&quot;</span><span class="p">)</span>
            <span class="n">hpopt_arguments</span><span class="p">[</span><span class="s2">&quot;num_trials&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_trials&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">algo</span> <span class="o">==</span> <span class="s2">&quot;asha&quot;</span><span class="p">:</span>
            <span class="n">hpopt_arguments</span><span class="p">[</span><span class="s2">&quot;num_brackets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_brackets&quot;</span><span class="p">)</span>
            <span class="n">hpopt_arguments</span><span class="p">[</span><span class="s2">&quot;reduction_factor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reduction_factor&quot;</span><span class="p">)</span>
            <span class="n">hpopt_arguments</span><span class="p">[</span><span class="s2">&quot;min_iterations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min_iterations&quot;</span><span class="p">)</span>
            <span class="n">hpopt_arguments</span><span class="p">[</span><span class="s2">&quot;num_trials&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hpopt_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_trials&quot;</span><span class="p">)</span>
            <span class="n">hpopt_arguments</span><span class="p">[</span><span class="s2">&quot;num_workers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_available_gpus</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_gpus_per_trial</span>

            <span class="c1"># Prevent each trials from being stopped during warmup stage</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="n">default_hyper_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">batch_size_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;min_iterations&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hpopt_cfg</span> <span class="ow">and</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_is_mpa_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
                    <span class="n">hpopt_arguments</span><span class="p">[</span><span class="s2">&quot;min_iterations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ceil</span><span class="p">(</span>
                        <span class="n">env_hp</span><span class="o">.</span><span class="n">learning_parameters</span><span class="o">.</span><span class="n">learning_rate_warmup_iters</span> <span class="o">/</span> <span class="n">ceil</span><span class="p">(</span><span class="n">train_dataset_size</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span>
                    <span class="p">)</span>

        <span class="n">HpoManager</span><span class="o">.</span><span class="n">remove_empty_keys</span><span class="p">(</span><span class="n">hpopt_arguments</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[otx.cli] [DEBUG-HPO] hpopt args for create hpopt = </span><span class="si">{</span><span class="n">hpopt_arguments</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># pylint: disable=unexpected-keyword-arg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hpo</span> <span class="o">=</span> <span class="n">hpopt</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">hpopt_arguments</span><span class="p">)</span>

<div class="viewcode-block" id="HpoManager.check_resumable"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoManager.check_resumable">[docs]</a>    <span class="k">def</span> <span class="nf">check_resumable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if HPO could be resumed from the previous result.</span>

<span class="sd">        If previous results are found, ask the user if resume or start from scratch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resume_flag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">hpo_previous_status</span> <span class="o">=</span> <span class="n">hpopt</span><span class="o">.</span><span class="n">get_previous_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hpo_previous_status</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="n">hpopt</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">PARTIALRESULT</span><span class="p">,</span>
            <span class="n">hpopt</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">COMPLETERESULT</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Previous HPO results are found in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">retry_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hpo_previous_status</span> <span class="o">==</span> <span class="n">hpopt</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">PARTIALRESULT</span><span class="p">:</span>
                    <span class="n">user_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Do you want to resume HPO? [</span><span class="se">\033</span><span class="s2">[1mY</span><span class="se">\033</span><span class="s2">[0m/n]: &quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">user_input</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Do you want to reuse previously found hyper-parameters? [</span><span class="se">\033</span><span class="s2">[1mY</span><span class="se">\033</span><span class="s2">[0m/n]: &quot;</span><span class="p">)</span>

                <span class="n">input_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">input_len</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># It means that an user accepted the default choice.</span>
                    <span class="n">resume_flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>

                <span class="k">if</span> <span class="n">input_len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">user_input</span> <span class="o">=</span> <span class="n">user_input</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">user_input</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">user_input</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                            <span class="n">resume_flag</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">work_dir</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">break</span>

                <span class="n">retry_count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">retry_count</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Your inputs are invalid. The whole program is terminating...&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You should type &#39;y&#39; or &#39;n&#39;. Nothing means &#39;y&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resume_flag</span></div>

<div class="viewcode-block" id="HpoManager.run"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoManager.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute HPO according to configuration.&quot;&quot;&quot;</span>
        <span class="n">task_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">task_type</span>
        <span class="n">proc_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">gpu_alloc_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_workers</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algo</span> <span class="o">==</span> <span class="s2">&quot;asha&quot;</span><span class="p">:</span>
            <span class="n">num_workers</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_gpus_per_trial</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">num_active_workers</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">proc</span><span class="p">,</span> <span class="n">gpu</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">proc_list</span><span class="p">),</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">gpu_alloc_list</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                    <span class="n">num_active_workers</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">proc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">proc_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
                    <span class="n">gpu_alloc_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">gpu</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">num_active_workers</span> <span class="o">==</span> <span class="n">num_workers</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">num_active_workers</span> <span class="o">&lt;</span> <span class="n">num_workers</span><span class="p">:</span>
                <span class="n">hp_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpo</span><span class="o">.</span><span class="n">get_next_sample</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">hp_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Wait for unfinished trials</span>
                    <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">proc_list</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
                            <span class="n">proc</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                    <span class="k">break</span>

                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_hp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

                <span class="n">hp_config</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span>

                <span class="n">hpo_work_dir</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">_get_hpo_trial_workdir</span><span class="p">(</span><span class="n">hp_config</span><span class="p">))</span>

                <span class="c1"># Clear hpo_work_dir</span>
                <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">hpo_work_dir</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">hpo_work_dir</span><span class="p">)</span>
                <span class="n">Path</span><span class="p">(</span><span class="n">hpo_work_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;hp_config&quot;</span><span class="p">:</span> <span class="n">hp_config</span><span class="p">,</span>
                    <span class="s2">&quot;hyper_parameters&quot;</span><span class="p">:</span> <span class="n">_convert_parameter_group_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_hyper_parameters</span><span class="p">()),</span>
                    <span class="s2">&quot;model_template&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">model_template</span><span class="p">,</span>
                    <span class="s2">&quot;dataset_paths&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_paths</span><span class="p">,</span>
                    <span class="s2">&quot;task_type&quot;</span><span class="p">:</span> <span class="n">task_type</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="n">pickle_path</span> <span class="o">=</span> <span class="n">HpoManager</span><span class="o">.</span><span class="n">safe_pickle_dump</span><span class="p">(</span><span class="n">hpo_work_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;hpo_trial_</span><span class="si">{</span><span class="n">hp_config</span><span class="p">[</span><span class="s1">&#39;trial_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">_kwargs</span><span class="p">)</span>

                <span class="n">alloc_gpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__alloc_gpus</span><span class="p">(</span><span class="n">gpu_alloc_list</span><span class="p">)</span>

                <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">exec_hpo_trainer</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">pickle_path</span><span class="p">,</span>
                        <span class="n">alloc_gpus</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">proc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">gpu_alloc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alloc_gpus</span><span class="p">)</span>
                <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="n">num_active_workers</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1"># All trials are done.</span>
            <span class="k">if</span> <span class="n">num_active_workers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">best_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpo</span><span class="o">.</span><span class="n">get_best_config</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_hp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">best_config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="n">hyper_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">get_hyper_parameters</span><span class="p">()</span>
        <span class="n">HpoManager</span><span class="o">.</span><span class="n">set_hyperparameter</span><span class="p">(</span><span class="n">hyper_parameters</span><span class="p">,</span> <span class="n">best_config</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hpo</span><span class="o">.</span><span class="n">print_results</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best Hyper-parameters&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">best_config</span><span class="p">)</span>

        <span class="c1"># get weight to pass for resume</span>
        <span class="n">hpo_weight_path</span> <span class="o">=</span> <span class="n">_get_best_model_weight_path</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hpo</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hpo</span><span class="o">.</span><span class="n">hpo_status</span><span class="p">[</span><span class="s2">&quot;best_config_id&quot;</span><span class="p">]),</span> <span class="n">task_type</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">hyper_parameters</span><span class="p">,</span> <span class="n">hpo_weight_path</span></div>

<div class="viewcode-block" id="HpoManager.__alloc_gpus"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoManager.__alloc_gpus">[docs]</a>    <span class="k">def</span> <span class="nf">__alloc_gpus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gpu_alloc_list</span><span class="p">):</span>
        <span class="n">gpu_list</span> <span class="o">=</span> <span class="n">get_cuda_device_list</span><span class="p">()</span>
        <span class="c1"># CPU-mode</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gpu_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">alloc_gpus</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">flat_gpu_alloc_list</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">gpu_alloc_list</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">gpu_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flat_gpu_alloc_list</span><span class="p">:</span>
                <span class="n">alloc_gpus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alloc_gpus</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_gpus_per_trial</span><span class="p">:</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alloc_gpus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_gpus_per_trial</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No available GPU!!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">alloc_gpus</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="HpoManager.generate_hpo_search_space"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoManager.generate_hpo_search_space">[docs]</a>    <span class="k">def</span> <span class="nf">generate_hpo_search_space</span><span class="p">(</span><span class="n">hp_space_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate search space from user&#39;s input.&quot;&quot;&quot;</span>
        <span class="n">search_space</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">hp_space_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># pylint: disable=no-member</span>
            <span class="n">search_space</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">hpopt</span><span class="o">.</span><span class="n">SearchSpace</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="s2">&quot;param_type&quot;</span><span class="p">],</span> <span class="n">val</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">search_space</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="HpoManager.remove_empty_keys"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoManager.remove_empty_keys">[docs]</a>    <span class="k">def</span> <span class="nf">remove_empty_keys</span><span class="p">(</span><span class="n">arg_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove keys with null values in the arg_dict dictionary.&quot;&quot;&quot;</span>
        <span class="n">del_candidate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">arg_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">del_candidate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">del_candidate</span><span class="p">:</span>
            <span class="n">arg_dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">del_candidate</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="HpoManager.get_num_full_iterations"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoManager.get_num_full_iterations">[docs]</a>    <span class="k">def</span> <span class="nf">get_num_full_iterations</span><span class="p">(</span><span class="n">environment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the number of full iterations for the specified environment.&quot;&quot;&quot;</span>
        <span class="n">num_full_iterations</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">task_type</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">model_template</span><span class="o">.</span><span class="n">task_type</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">get_hyper_parameters</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">_is_mpa_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
            <span class="n">learning_parameters</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">learning_parameters</span>
            <span class="n">num_full_iterations</span> <span class="o">=</span> <span class="n">learning_parameters</span><span class="o">.</span><span class="n">num_iters</span>
        <span class="k">elif</span> <span class="n">_is_anomaly_framework_task</span><span class="p">(</span><span class="n">task_type</span><span class="p">):</span>
            <span class="n">learning_parameters</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">learning_parameters</span>
            <span class="n">num_full_iterations</span> <span class="o">=</span> <span class="n">learning_parameters</span><span class="o">.</span><span class="n">max_epochs</span>

        <span class="k">return</span> <span class="n">num_full_iterations</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="HpoManager.safe_pickle_dump"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoManager.safe_pickle_dump">[docs]</a>    <span class="k">def</span> <span class="nf">safe_pickle_dump</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dump a pickle file with minimal file permission.&quot;&quot;&quot;</span>
        <span class="n">pickle_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">.pickle&quot;</span><span class="p">)</span>

        <span class="n">oldmask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mo">0o077</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pfile</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pfile</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">oldmask</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pickle_path</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="HpoManager.set_hyperparameter"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoManager.set_hyperparameter">[docs]</a>    <span class="k">def</span> <span class="nf">set_hyperparameter</span><span class="p">(</span><span class="n">origin_hp</span><span class="p">,</span> <span class="n">hp_config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set given hyper parameter to hyper parameter in environment aligning with &quot;ConfigurableParameters&quot;.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">param_key</span><span class="p">,</span> <span class="n">param_val</span> <span class="ow">in</span> <span class="n">hp_config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">param_key</span> <span class="o">=</span> <span class="n">param_key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

            <span class="n">target</span> <span class="o">=</span> <span class="n">origin_hp</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">param_key</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">param_key</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">param_val</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HpoDataset"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoDataset">[docs]</a><span class="k">class</span> <span class="nc">HpoDataset</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Wrapper class for DatasetEntity of dataset.</span>

<span class="sd">    It&#39;s used to make subset during HPO.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fullset</span><span class="p">:</span> <span class="n">DatasetEntity</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fullset</span> <span class="o">=</span> <span class="n">fullset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subset_ratio</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;subset_ratio&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="HpoDataset.__len__"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoDataset.__len__">[docs]</a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Gets size of dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span></div>

<div class="viewcode-block" id="HpoDataset.__getitem__"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoDataset.__getitem__">[docs]</a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get item from dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullset</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">[</span><span class="n">indx</span><span class="p">]]</span></div>

<div class="viewcode-block" id="HpoDataset.__getattr__"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoDataset.__getattr__">[docs]</a>    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get attribute from fullset.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__setstate__&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fullset</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="HpoDataset.get_subset"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoDataset.get_subset">[docs]</a>    <span class="k">def</span> <span class="nf">get_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="p">:</span> <span class="n">Subset</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get subset according to subset_ratio if training dataset is requested.&quot;&quot;&quot;</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullset</span><span class="o">.</span><span class="n">get_subset</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="o">!=</span> <span class="n">Subset</span><span class="o">.</span><span class="n">TRAINING</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">subset_ratio</span> <span class="o">&gt;</span> <span class="mf">0.99</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dataset</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randperm</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="n">generator</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Generator</span><span class="p">()</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">))</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">subset_ratio</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">HpoDataset</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HpoUnpickler"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoUnpickler">[docs]</a><span class="k">class</span> <span class="nc">HpoUnpickler</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">Unpickler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Safe unpickler for HPO.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="HpoUnpickler.__safe_builtins"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoUnpickler.__safe_builtins">[docs]</a>    <span class="n">__safe_builtins</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;range&quot;</span><span class="p">,</span>
        <span class="s2">&quot;complex&quot;</span><span class="p">,</span>
        <span class="s2">&quot;set&quot;</span><span class="p">,</span>
        <span class="s2">&quot;frozenset&quot;</span><span class="p">,</span>
        <span class="s2">&quot;slice&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dict&quot;</span><span class="p">,</span>
    <span class="p">}</span></div>

<div class="viewcode-block" id="HpoUnpickler.__safe_collections"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoUnpickler.__safe_collections">[docs]</a>    <span class="n">__safe_collections</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;OrderedDict&quot;</span><span class="p">,</span> <span class="s2">&quot;defaultdict&quot;</span><span class="p">}</span></div>

<div class="viewcode-block" id="HpoUnpickler.__allowed_classes"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoUnpickler.__allowed_classes">[docs]</a>    <span class="n">__allowed_classes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;datetime&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timezone&quot;</span><span class="p">,</span>
            <span class="s2">&quot;timedelta&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;networkx.classes.graph&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Graph&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;networkx.classes.multidigraph&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;MultiDiGraph&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;otx.api.configuration.enums.config_element_type&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;ConfigElementType&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;otx.api.entities.label_schema&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;LabelTree&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LabelGroup&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LabelGroupType&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LabelSchemaEntity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LabelGraph&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;otx.api.entities.id&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;ID&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;otx.api.entities.label&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Domain&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LabelEntity&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;otx.api.entities.color&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;Color&quot;</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;otx.api.entities.model_template&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;ModelTemplate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TaskFamily&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TaskType&quot;</span><span class="p">,</span>
            <span class="s2">&quot;InstantiationType&quot;</span><span class="p">,</span>
            <span class="s2">&quot;TargetDevice&quot;</span><span class="p">,</span>
            <span class="s2">&quot;DatasetRequirements&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HyperParameterData&quot;</span><span class="p">,</span>
            <span class="s2">&quot;EntryPoints&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ExportableCodePaths&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span></div>

<div class="viewcode-block" id="HpoUnpickler.find_class"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.HpoUnpickler.find_class">[docs]</a>    <span class="k">def</span> <span class="nf">find_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_name</span><span class="p">,</span> <span class="n">class_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find class in module_name.&quot;&quot;&quot;</span>
        <span class="c1"># Only allow safe classes from builtins.</span>
        <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;builtins&quot;</span><span class="p">,</span> <span class="s2">&quot;__builtin__&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__safe_builtins</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builtins</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">module_name</span> <span class="o">==</span> <span class="s2">&quot;collections&quot;</span> <span class="ow">and</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__safe_collections</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">collections</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">allowed_module_name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__allowed_classes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">module_name</span> <span class="o">==</span> <span class="n">allowed_module_name</span> <span class="ow">and</span> <span class="n">class_name</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">class_name</span><span class="p">)</span>

        <span class="c1"># Forbid everything else.</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">UnpicklingError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;global &#39;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">class_name</span><span class="si">}</span><span class="s2">&#39; is forbidden&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../../api/otx/cli/utils/hpo/index.html#otx.cli.utils.hpo.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Run run_hpo_trainer with a pickle file.&quot;&quot;&quot;</span>
    <span class="n">hp_config</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># to prevent importing nncf from this directory</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pfile</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="n">HpoUnpickler</span><span class="p">(</span><span class="n">pfile</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
            <span class="n">hp_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;hp_config&quot;</span><span class="p">]</span>

            <span class="n">run_hpo_trainer</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;CUDA out of memory&quot;</span><span class="p">):</span>
            <span class="n">hpopt</span><span class="o">.</span><span class="n">reportOOM</span><span class="p">(</span><span class="n">hp_config</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, OpenVINO Training Extensions Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>